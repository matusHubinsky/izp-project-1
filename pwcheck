#include<stdio.h>
// #include<limits.h>
#include<stdbool.h>
#include<stdlib.h>

#define MAX_LENGHT 100
#define ERR 13
#define MAX_CHARACTER 126
#define MIN_CHARACTER 32


enum levels {LVL1=1, LVL2=2, LVL3=3, LVL4=4};


typedef struct Stats
{
    long sum;
    long min;
    long number;    
    long symbols[MAX_CHARACTER];
} Stats;


typedef struct s_line
{
    char * ptr;
    bool valid;

} S_line;


void printLine(char line[MAX_LENGHT])
{
    int k = 0;
    for (long i = 0; line[i] != '\0'; i++)
    {
        printf("%c", line[i]);
        k = i;
    }
    printf("%c\n", line[k + 1]);
}


bool compareCharArrays(char cArr1[], char cArr2[])
{
    long lenght1 = 0;
    long lenght2 = 0;

    for (long i = 0; cArr1[i] != '\0'; i++) lenght1++; 
    for (long i = 0; cArr2[i] != '\0'; i++) lenght2++;

    if (lenght1 != lenght2) return false;

    for (long i = 0; i < lenght1; i++)
    {
        if (cArr1[i] != cArr2[i]) return false;
    }
    return true;
}


long getLength(char line[])
{
    long lenght = 1; // zacinan na 1 kvoli termnacnej podmi
    for (long i = 0; line[i] != '\0'; i++) lenght++;
    return lenght;
}



struct s_line manageInput(S_line s_line, char character, char line[])
{
    long i = 0;
    int ord = character;

    s_line.valid = true;

    while ((ord != ERR) && (i <= MAX_LENGHT) && (character != EOF) && (character != '\n') && (character != '\0'))    
    {
        if ((ord < MIN_CHARACTER) || (ord > MAX_CHARACTER)) s_line.valid = false;     
        line[i] = character;
        i++;
        character = getchar();
        ord = character;
    }
    
    if (i <= MAX_LENGHT) line[i] = '\0';
    else s_line.valid = false;

    char * cptr = line; 
    s_line.ptr = cptr;

    return s_line;
}


bool firstCondition(char line[], long lenght)
{
    bool small = false; 
    bool big = false;

    for (long i = 0; i < lenght; i++)
    {
        int ord = (int)line[i];
        if ((ord >= 'A') && (ord <= 'Z')) big = true;
        else if ((ord >= 'a') && (ord <= 'z')) small = true;
        
        if ((small == true) && (big == true)) 
        {
            return true;
        }
    }
    return false;    
}


bool secondCondition(long param, char line[], long lenght)
{
    bool small = false;
    bool big = false;
    bool number = false;
    bool special = false;

    for (long i = 0; i < lenght; i++)
    {
        int ord = (int)line[i];
        if ((ord >= 'A') && (ord <= 'Z')) big = true;
        else if ((ord >= 'a') && (ord <= 'z')) small = true;
        else if ((ord >= '0') && (ord <= '9')) number = true;
        else if ((ord >= ' ') && (ord <= '~')) special = true;
    
        int approved = (int)small + (int)big + (int)number + (int)special;
        if (param <= 4)
        {
            if (approved >= param) return true;  
        } 
        if (param > 4)
        {
            if (approved == 4) return true;  
        } 
    }
    return false; 
}


bool thirdCondition(long param, char line[], long lenght)
{
    int number = 1;
    if (param > lenght) return true;
    for (long i = 1; i < lenght; i++)
    {
        if (line[i-1] == line[i]) number++;
        else if (number >= param) return false; 
        else number = 1;
    }
    return true;
}


bool fourthCondition(long param, char line[], long lenght)
{
    bool valid;

    if (param > lenght) return true;

    for (long i = 0; i < lenght; i++)
    {
        for (long j = 0; j < lenght; j++)
        {
            valid = true;
            int k = 0;
            for (long p = 0; p < param; p++)
            {       
                if ((line[i + p] == line[j + p]) && (j != i))
                {   
                    valid = false;
                    k++;
                }
                else
                {
                    valid = true;
                }
            }
            if (valid == false && k == param)
            {
                return false;                    
            } 
        }
    }
    return true;
}


bool checkPassword(long level, long param, char line[], long lenght)
{
    bool valid = false;

    if (level == LVL1)
    {
        if (firstCondition(line, lenght)) valid = true;   
    }
    else if (level == LVL2)
    {
        if ((firstCondition(line, lenght)) && (secondCondition(param, line, lenght))) valid = true;
    }
    else if (level == LVL3)
    {
        if ((firstCondition(line, lenght)) && (secondCondition(param, line, lenght)) && (thirdCondition(param, line, lenght))) valid = true;
    }
    else if (level == LVL4)
    {
        if ((firstCondition(line, lenght)) && (secondCondition(param, line, lenght)) && (thirdCondition(param, line, lenght)) && (fourthCondition(param, line, lenght))) valid = true;
    }

    return valid;
}


struct Stats updateStats(Stats stats, char line[], long lenght)
{
    int ord;
    for (long i = 0; i < lenght; i++)
    {
        ord = (int)line[i];
        if ((stats.symbols[ord] == 0) && (ord >= ' ') && (ord <= '~')) stats.symbols[ord]++;
    }
    if (lenght < stats.min) stats.min = lenght - 1;
    stats.sum += (lenght - 1);
    stats.number++;
    return stats;
}


struct Stats prepareStats(Stats stats)
{
    stats.min = MAX_LENGHT;
    stats.number = 0;
    stats.sum = 0;
    for (long i = 0; i < MAX_CHARACTER; i++) stats.symbols[i] = 0;
    return stats;
}


void printStats(Stats stats)
{
    long sum_symbols = 0;
    float priemer;
    for (long i = 0; i < MAX_CHARACTER; i++) sum_symbols += stats.symbols[i];
    
    if (sum_symbols != 0)
    {
        priemer = (float)stats.sum / (float)stats.number;
    }
    else 
    {
        priemer = 0.0f;
        stats.min = 0;
    }   
    printf("Statistika:\n");
    printf("Ruznych znaku: %li\n", sum_symbols);
    printf("Minimalni delka: %li\n", stats.min);
    printf("Prumerna delka: %.1f\n", priemer);
}


bool kontrola(char line[])
{
    for (long i = 0; line[i] != '\0'; i++)
    {
        if (line[i] < '0' || line[i] > '9') return false;
    }
    return true;
}


int main(int argc, char *argv[])
{
    Stats stats;
    S_line s_line;
    
    if (argc < 3)
    {
        fprintf(stderr, "Malo argumentov\n");
        return 1;        
    }

    if (kontrola(argv[1]) == false)
    {
        fprintf(stderr, "Divny level\n");
        return 1;                
    }

    if (kontrola(argv[2]) == false)
    {
        fprintf(stderr, "Divne parametre\n");
        return 1;        
    }

    long number = argc;
    char * end;
    long level = strtoul(argv[1], &end, 10);
    long param = strtoul(argv[2], &end, 10);

    if ((level <= 0) || (level >= 5))
    {
        fprintf(stderr, "Divny level\n");
        return 1;  
    } 
    if (param == 0)
    {
        fprintf(stderr, "Parameter 0\n");
        return 1;
    } 
    if (param < 1)
    {
        param = MAX_LENGHT;
    }
    if (number == 4)
    {
        if (compareCharArrays(argv[3], "--stats"))
        {
            stats = prepareStats(stats);
        }
        else
        {
            fprintf(stderr, "Stats zly argumen\n");  
            return 1; 
        }
    }
    else if (number > 4) 
    {
        fprintf(stderr, "Vela argumentov \n");  
        return 1;
    }

    char character;
    character = getchar();
 
    while ((character != EOF))
    {
        char line[MAX_LENGHT];
        s_line= manageInput(s_line, character, line);
        char * lineptr = s_line.ptr;

        if (s_line.valid != false) 
        {
            long lenght = getLength(line);
            stats = updateStats(stats, line, lenght);
            if (checkPassword(level, param, line, lenght)) printf("%s\n", lineptr);
        }
        else
        {
            fprintf(stderr, "Divny vstup\n");
            return 1;        
        }

        character = getchar();
    }

    if (number >= 4) printStats(stats);

    return 0;
}


// <> diamant .... signle entry, single exit.....to tiez znie blbo
// umpersand natrenovat
// main nemoze mat viac ako 50 riadkov
